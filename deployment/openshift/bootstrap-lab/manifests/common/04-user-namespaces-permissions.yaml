---
apiVersion: batch/v1
kind: Job
metadata:
  name: user-namespace-permissions-create
  namespace: openshift-gitops
  annotations:
    argocd.argoproj.io/sync-wave: "4"
spec:
  template:
    spec:
      serviceAccountName: openshift-gitops-argocd-application-controller
      containers:
      - name: shell
        image: quay.io/luisarizmendi/ocp-job:latest  
        command: ["/bin/sh", "-c"]
        args:
        - |
          oc apply -f - <<EOF
          apiVersion: security.openshift.io/v1
          kind: SecurityContextConstraints
          metadata:
            name: custom-buildkit-scc
          allowPrivilegedContainer: true
          allowHostDirVolumePlugin: false
          allowHostNetwork: false
          allowHostPorts: false
          allowHostPID: false
          allowHostIPC: false
          allowAnyHostPorts: false
          volumes:
            - configMap
            - downwardAPI
            - emptyDir
            - projected
            - secret
            - persistentVolumeClaim
          readOnlyRootFilesystem: false
          runAsUser:
            type: RunAsAny
          seLinuxContext:
            type: RunAsAny
          fsGroup:
            type: RunAsAny
          users: []
          groups: []
          EOF

          # Loop through users user01 to user50 and user99
          for i in $(seq -w 1 50) 99; do
            namespace_source="user${i}-ai"
            for n in tools; do
              namespace_dest=user${i}-${n}

              while true; do
                  if oc get namespace "$namespace_source" &> /dev/null; then
                      echo "Namespace '$namespace_source' has been created successfully!"
                      break
                  fi
                  sleep 10
              done
              while true; do
                  if oc get namespace "$namespace_dest" &> /dev/null; then
                      echo "Namespace '$namespace_dest' has been created successfully!"
                      break
                  fi
                  sleep 10
              done

              echo "Enabling access to $namespace_source from namespace $namespace_dest"
          oc apply -f - <<EOF
          apiVersion: rbac.authorization.k8s.io/v1
          kind: Role
          metadata:
            name: pipeline-executor
            namespace: $namespace_dest
          rules:
            - apiGroups: ["tekton.dev"]
              resources: ["pipelineruns"]
              verbs: ["create", "get", "list", "watch"]
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: pipeline-runner-access
            namespace: $namespace_dest
          subjects:
            - kind: ServiceAccount
              name: pipeline-runner-dspa
              namespace: $namespace_source
          roleRef:
            kind: Role
            name: pipeline-executor
            apiGroup: rbac.authorization.k8s.io
          ---
          apiVersion: rbac.authorization.k8s.io/v1
          kind: RoleBinding
          metadata:
            name: use-custom-buildkit-scc
            namespace: $namespace_dest
          subjects:
            - kind: ServiceAccount
              name: pipeline
              namespace: $namespace_dest
          roleRef:
            kind: ClusterRole
            name: custom-buildkit-scc
            apiGroup: rbac.authorization.k8s.io
          EOF
            done
          done 
          echo "Environment ready!"
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
              - "ALL"
          runAsNonRoot: true
          seccompProfile:
            type: RuntimeDefault
      restartPolicy: Never
  backoffLimit: 1
